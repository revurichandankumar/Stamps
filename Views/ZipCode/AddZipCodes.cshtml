@model OneposStamps.Models.GetZipCodeData
@{
    ViewBag.Title = "AddZipCodes";
}
<body data-layout="horizontal" class="dark-topbar">

    <div class="page-wrapper">
        <!-- Page Content-->
        <div class="page-content">

            <div class="container-fluid">
                <!-- Page-Title -->
                <div class="row justify-content-center">
                    <div class="col-sm-6">
                        <div class="page-title-box d-flex align-items-center">
                            <a onclick="openzonedetailsview()" class="btn btn-outline-primary btn-round waves-effect waves-light mr-3"><i class="mdi mdi-keyboard-backspace mr-2"></i>Back</a>
                            <h4 class="page-title font-weight-bold">@Model.ZoneName <span class="btn table-btn btn-dark">@Model.CarrierName</span></h4>

                        </div><!--end page-title-box-->
                    </div><!--end col-->

                </div>
                <!-- end page title end breadcrumb -->

                <div class="row justify-content-center">
                    <div class="col-sm-6">

                        <div class="card">
                            <div class="card-body">

                                <form action="" class="d-flex mb-5">
                                    <div class="form-group col mb-0">
                                        <label for="">State</label>
                                        <input type="text" id="txtState" class="form-control" placeholder="State name" value="CA" />
                                    </div>
                                    <div class="form-group col mb-0">
                                        <label for="">City</label>
                                        <input type="text" id="txtCity" class="form-control" placeholder="City name" />
                                    </div>

                                    <div class="form-group col mb-0">
                                        <label for="">Zip Code</label>
                                        <input type="text" id="txtZipcode" class="form-control" placeholder="Zip Code" />
                                    </div>

                                    <div class="col-auto align-self-end">
                                        <input type='button' onclick="onFilerClick()" id='btnFilter' class="btn btn-primary" value='Filter' />
                                    </div>
                                </form>

                            </div>
                        </div>

                       <div  id="divZipcodeList"></div>

                        <div class="row">
                            <div class="col-md-12 text-center">
                                <input type='button' onclick="onSaveZipcodes()" id='btnSaveZip' class="btn btn-primary" value='Save Zip Codes' />
                            </div>
                        </div>



                    </div>


                </div>

            </div><!-- container -->

        </div>
        <!-- end page content -->
    </div>
    <!-- end page-wrapper -->

    <div class="alert alert-success alert-dismissible fade show float-alert" style="display:none" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true"><i class="mdi mdi-close"></i></span>
        </button>
        Zipcodes added <strong>Successfully.</strong>
    </div>

</body>

<script>

    function openzonedetailsview() {
        var storeid = '@Model.StoreId';
        var zoneid = '@Model.ZoneId';
        window.location.href = '@Url.Action("GetZonesData", "Zone")?StoreId=' + storeid +'&ZoneId=' + zoneid ;
    }

    $(document).ready(function () {
        onPageLoad();
    });

    function onPageLoad() {
          var data = {
              StateName: $("#txtState").val(),
              CityName: $("#txtCity").val(),
              ZipCode: $("#txtZipcode").val(),
              StoreId: '@Model.StoreId',
              ZoneId: '@Model.ZoneId',
        }

        $.ajax({
            type: "POST",
            url: "/ZipCode/AddZipCodes",
            //contentType: "application/json; charset=utf-8",
            //dataType: "json",
            data: data,
            success: function (response) {
                $('#divZipcodeList').html(response);
            },
            error: function (response) {
                alert(response.statusText);
            }
        });
    }

    function onFilerClick() {
        var divAddedZipCode = $('#addedZipcodes').find('.card-header');
        
        var ziplist = [];

        for (var i = 0; i < divAddedZipCode.length; i++) {

            var headerid = "Rheading" + i;
            var collapseid = "Rcollapse" + i;

            var cityid = $('#' + headerid + ' a');
            var zipcodeid = $('#' + collapseid + ' li');

            if (cityid.length == 0) {
                alert("Something went wrong.Please try again.")
                return false;
            }
            var cityNameValue = cityid[0].innerText;
            var zipcodeValue = $('#' + collapseid + ' li');  //[0].innerText;

            for (var j = 0; j < zipcodeValue.length; j++) {
                ziplist.push({ Name: cityNameValue, Zipcode: zipcodeValue[j].innerText });
            }           

        }

        var objzipcodeFilters = {
            StateName: $("#txtState").val(),
            CityName: $("#txtCity").val(),
            ZipCode: $("#txtZipcode").val(),
            StoreId: '@Model.StoreId',
            ZoneId: '@Model.ZoneId',
        }

        var objSearchedZipCodes = {
            zipcodeFilters : objzipcodeFilters,
            ZipCodeList: ziplist
        }

        $.ajax({
            type: "POST",
            url: "/ZipCode/SearchByFilerZipcodes",
            //contentType: "application/json; charset=utf-8",
            //dataType: "json",
            data: { sz: objSearchedZipCodes },
            success: function (response) {
                $('#divSearchResult').html(response);
            },
            error: function (response) {
                alert(response.statusText);
            }
        });
    }

    function onSaveZipcodes() {

        var divAddedZipCode = $('#addedZipcodes').find('.card-header');
        
        var ziplist = [];

        for (var i = 0; i < divAddedZipCode.length; i++) {

            var headerid = "Rheading" + i;
            var collapseid = "Rcollapse" + i;

            var cityid = $('#' + headerid + ' a');
            var zipcodeid = $('#' + collapseid + ' li');

            if (cityid.length == 0) {
                alert("Something went wrong.Please try again.")
                return false;
            }
            var cityNameValue = cityid[0].innerText;
            var zipcodeValue = $('#' + collapseid + ' li');  //[0].innerText;

            for (var j = 0; j < zipcodeValue.length; j++) {
                ziplist.push({ Name: cityNameValue, Zipcode: zipcodeValue[j].innerText });
            }           

        }

        var data = {
            ZipCodeList : ziplist,
            StoreId : '@Model.StoreId',
            ZoneId : '@Model.ZoneId'
        };

        $.ajax({
            type: "POST",
            url: "/ZipCode/InsertZipCodestoZone",
            //contentType: "application/json; charset=utf-8",
            //dataType: "json",
            data: data,
            success: function (response) {
                debugger
                if (response.result == 'Redirect')
                    window.location.href = response.url;
                //$("#divSuccess").attr("style='display:visible'");
            },
            error: function (response) {
                alert(response.responseText);
            }
        });
    }


</script>